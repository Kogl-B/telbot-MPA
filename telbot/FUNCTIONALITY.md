# TelBot 2.0 — Полный функционал бота

> Автоматическая дата анализа: 28 февраля 2026 г.

---

## 1. Общее описание

**TelBot 2.0** — серверный Telegram-бот для автоматического постинга изображений и видео в несколько Telegram-каналов по расписанию. Написан на Python, использует библиотеку `python-telegram-bot`.

Бот работает **только с готовым контентом** из папки `content/`. Сортировка и подготовка контента выполняется отдельной программой (`content_manager.py` в папке `sorter/`).

---

## 2. Основные возможности

### 2.1. Автопостинг в каналы
- Циклическая публикация изображений/видео в несколько Telegram-каналов по очереди (round-robin)
- Настраиваемый интервал между постами (по умолчанию 30 мин, конфигурируется)
- Настраиваемое активное время постинга (`first_post_hour` — `last_post_hour`)
- Автоматическое удаление файла после успешной публикации
- Автоматическое добавление хештегов категории к посту (подпись)
- При нехватке контента — уведомление администраторам

### 2.2. Поддерживаемые каналы (4 канала)
| Ключ | Название канала | Кол-во категорий |
|------|----------------|------------------|
| `mpa_disney` | Universe Disney Ero Art +18 | 6 (Princess Jasmin, Elsa, Anna, Group, Alice, Elsa and Anna) |
| `harry_potter` | Universe Harry Potter Erotic Art +18 | 4 (Hermione, Ginny, Luna, Hermione and Ginny) |
| `atla` | Universe The Avatar Legend of AANG Ero Art +18 | 7 (Katara, Azula, Tai Le, Mai, Yui, Toph, Korra) |
| `naruto` | Universe Naruto Ero Art +18 | 8 (Sakura, Hinata, Tsunade, Hanabi, Ino, TenTen, Temari, Kushina) |

### 2.3. Загрузка контента через бота
- Администратор может отправить фото боту в личные сообщения
- Фото автоматически сортируется по хештегу в подписи (например, `#Sakura`)
- Хештег матчится к категории и каналу через конфигурацию
- Уникальное имя файла генерируется автоматически (с timestamp + random ID)

### 2.4. Месячные пакеты контента
- Контент организован в месячные папки (`content/YYYY-MM/`)
- Бот сканирует все месячные папки при выборе изображения
- Случайный выбор изображения из всех доступных пакетов

### 2.5. Автозапуск и перезапуск
- Бот автоматически запускает постинг через 5 секунд после старта
- Ежедневный автоматический перезапуск в 00:00 (полночь)
- Уведомление администраторов о перезапуске
- Сохранение состояния постинга между перезапусками (`posting_state.json`)

---

## 3. Команды бота (Telegram)

Все команды доступны **только администраторам** (проверка по `admin_ids`).

| Команда | Описание |
|---------|----------|
| `/start` | Приветственное сообщение |
| `/help` | Справка по всем командам |
| `/status` | Текущий статус: постинг вкл/выкл, интервал, время до следующего поста, следующий канал, кол-во контента |
| `/stats` | Детальная статистика контента: всего файлов, по каналам, по категориям, прогноз на сколько дней хватит |
| `/channels` | Список всех каналов с количеством категорий и статусом (вкл/выкл) |
| `/posting_start` | Запуск цикла автопостинга |
| `/posting_stop` | Остановка автопостинга |
| `/post_now` | Немедленная публикация в следующий канал по очереди |
| `/post_now <channel>` | Немедленная публикация в указанный канал (например `/post_now atla`) |
| `/test` | Тест подключения ко всем активным каналам |

---

## 4. Аргументы командной строки

| Аргумент | Описание |
|----------|----------|
| `python telbot.py` | Запуск бота |
| `python telbot.py --status` | Вывод статистики контента в консоль (без запуска бота) |
| `python telbot.py --help` | Справка по аргументам |

---

## 5. Конфигурация

### 5.1. Иерархия конфигов
1. **`config/config.json`** — базовая конфигурация (шаблон)
2. **`config_custom.json`** — пользовательские переопределения (глубокий merge)

### 5.2. Ключевые параметры

#### Telegram
- `bot_token` — токен бота
- `admin_ids` — список ID администраторов
- `general_channel_id` — ID общего канала

#### Расписание (`schedule`)
- `post_interval_minutes` — интервал между постами (в минутах)
- `first_post_hour` — начало постинга (час, 0-23)
- `last_post_hour` — конец постинга (час, 0-24)
- `timezone` — часовой пояс (`Europe/Moscow`)

#### Каналы (`channels`)
Каждый канал содержит:
- `channel_id` — ID Telegram-канала
- `name` — отображаемое имя
- `enabled` — включен/выключен
- `categories` — словарь категорий, каждая с:
  - `folder_name` — имя папки в файловой системе
  - `hashtags` — список хештегов для постинга и матчинга
  - `keywords` — ключевые слова для поиска (используются в content_manager)

#### Поддерживаемые форматы
- Изображения: `.jpg`, `.jpeg`, `.png`, `.gif`, `.webp`
- Видео: `.mp4`, `.mov`, `.avi`, `.mkv`
- Максимальный размер файла: 10 МБ

---

## 6. Архитектура и классы

### 6.1. `TelegramPoster`
Основной класс, отвечающий за логику постинга:
- **Ротация каналов** — циклический обход каналов (`round-robin`)
- **Случайный выбор файла** — из всех месячных папок для текущего канала
- **Публикация и удаление** — после успешной отправки файл удаляется
- **Сохранение/загрузка состояния** — `posting_state.json` (индекс канала, время последнего поста)
- **Цикл автопостинга** — бесконечный цикл с проверкой активного времени
- **Поддержка форматов отправки**: фото, GIF (анимация), видео

### 6.2. `PhotoUploader`
Обработка загрузки фото через бота:
- Парсинг хештега из подписи
- Поиск категории/канала по хештегу
- Скачивание файла и сохранение с уникальным именем
- Сохранение в соответствующую папку контента

### 6.3. Вспомогательные функции
- `load_config()` — загрузка и merge конфигураций
- `deep_update()` — рекурсивное обновление словарей
- `get_enabled_channels()` — фильтр только включенных каналов
- `generate_unique_filename()` — генерация уникального имени файла
- `find_category_by_hashtag()` — поиск категории по хештегу
- `get_content_stats()` — сбор статистики по всему контенту
- `format_stats_message()` — форматирование статистики с прогнозом
- `escape_markdown()` — экранирование спецсимволов Markdown

---

## 7. Безопасность

- **Контроль доступа** — декоратор `@admin_only` на всех командах, проверка по Telegram user ID
- **Список админов** — настраивается в конфигурации (`admin_ids`)

---

## 8. Логирование

- Логи записываются в файл `logs/telbot_YYYYMMDD.log` (новый файл каждый день)
- Дублирование в stdout (консоль)
- Уровень: INFO

---

## 9. Деплой

- Systemd-сервис (`telbot.service`) для автозапуска на сервере
- Скрипты автоустановки:
  - `deploy.sh` — полная установка на сервере
  - `install_on_server.sh` — удалённая установка через SSH
  - `create_deploy_package.sh` — создание пакета для деплоя
  - `update_service.sh` — обновление сервиса
  - `fix_config.sh` — исправление конфигурации

---

## 10. Зависимости

| Пакет | Версия | Назначение |
|-------|--------|------------|
| `python-telegram-bot[job-queue]` | 22.5 | Telegram Bot API |
| `httpx` | 0.28.1 | HTTP-клиент (используется telegram-bot) |
| `apscheduler` | 3.11.2 | Планировщик задач |
| `tzlocal` | 5.3.1 | Определение локального часового пояса |

---

## 11. Структура файлов

```
telbot/
├── telbot.py              # Основной файл бота (872 строки)
├── config_custom.json      # Пользовательская конфигурация
├── posting_state.json      # Состояние постинга (сохраняется автоматически)
├── requirements.txt        # Python-зависимости
├── telbot.service          # Systemd unit-файл
├── config/
│   └── config.json         # Базовая конфигурация
├── content/                # Контент для публикации
│   ├── YYYY-MM/            # Месячные пакеты
│   │   ├── package_info.json
│   │   ├── atla/
│   │   ├── harry_potter/
│   │   ├── mpa_disney/
│   │   └── naruto/
├── archives/               # Архив (не используется активно в текущей версии)
├── logs/                   # Логи
├── temp/                   # Временные файлы
└── *.sh                    # Скрипты деплоя
```
